"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.quotasListCommand = void 0;
const client_service_quotas_1 = require("@aws-sdk/client-service-quotas");
const cli_1 = require("@remotion/cli");
const lambda_client_1 = require("@remotion/lambda-client");
const constants_1 = require("@remotion/lambda-client/constants");
const _1 = require(".");
const get_aws_region_1 = require("../../get-aws-region");
const log_1 = require("../../log");
const increase_1 = require("./increase");
const quotasListCommand = async (logLevel) => {
    var _a, _b, _c;
    const region = (0, get_aws_region_1.getAwsRegion)();
    log_1.Log.info({ indent: false, logLevel }, cli_1.CliInternals.chalk.gray(`Region = ${region}`));
    log_1.Log.info({ indent: false, logLevel });
    const [concurrencyLimit, defaultConcurrencyLimit, changes] = await Promise.all([
        lambda_client_1.LambdaClientInternals.getServiceQuotasClient(region, null).send(new client_service_quotas_1.GetServiceQuotaCommand({
            QuotaCode: constants_1.LAMBDA_CONCURRENCY_LIMIT_QUOTA,
            ServiceCode: 'lambda',
        })),
        lambda_client_1.LambdaClientInternals.getServiceQuotasClient(region, null).send(new client_service_quotas_1.GetAWSDefaultServiceQuotaCommand({
            QuotaCode: constants_1.LAMBDA_CONCURRENCY_LIMIT_QUOTA,
            ServiceCode: 'lambda',
        })),
        lambda_client_1.LambdaClientInternals.getServiceQuotasClient(region, null).send(new client_service_quotas_1.ListRequestedServiceQuotaChangeHistoryByQuotaCommand({
            QuotaCode: constants_1.LAMBDA_CONCURRENCY_LIMIT_QUOTA,
            ServiceCode: 'lambda',
        })),
    ]);
    const openCase = (_a = changes.RequestedQuotas) === null || _a === void 0 ? void 0 : _a.find((r) => r.Status === 'CASE_OPENED');
    const concurrencyCurrent = (_b = concurrencyLimit.Quota) === null || _b === void 0 ? void 0 : _b.Value;
    const defaultConcurrency = (_c = defaultConcurrencyLimit.Quota) === null || _c === void 0 ? void 0 : _c.Value;
    const increaseRecommended = concurrencyCurrent <= defaultConcurrency;
    if (increaseRecommended) {
        log_1.Log.info({ indent: false, logLevel }, `Concurrency limit: ${concurrencyCurrent} - ${increaseRecommended
            ? cli_1.CliInternals.chalk.greenBright('Increase recommended!')
            : ''}`);
    }
    else {
        log_1.Log.info({ indent: false, logLevel }, `Concurrency limit: ${concurrencyCurrent}`);
    }
    if (openCase) {
        log_1.Log.warn({ indent: false, logLevel }, `A request to increase it to ${openCase.DesiredValue} is pending:`);
        log_1.Log.warn({ indent: false, logLevel }, `https://${region}.console.aws.amazon.com/support/home#/case/?displayId=${openCase.CaseId}`);
    }
    log_1.Log.info({ indent: false, logLevel }, cli_1.CliInternals.chalk.gray('The maximum amount of Lambda functions which can concurrently execute.'));
    log_1.Log.info({ indent: false, logLevel }, cli_1.CliInternals.chalk.gray(`Run \`npx ${constants_1.BINARY_NAME} ${_1.QUOTAS_COMMAND} ${increase_1.INCREASE_SUBCOMMAND}\` to ask AWS to increase your limit.`));
    log_1.Log.info({ indent: false, logLevel });
    log_1.Log.info({ indent: false, logLevel }, cli_1.CliInternals.chalk.gray('The maximum amount of concurrency increase in 10 seconds'));
};
exports.quotasListCommand = quotasListCommand;
